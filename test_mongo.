<?php

require_once __DIR__ . '/vendor/autoload.php';

use MongoDB\Client;

$mongoUri = 'mongodb+srv://kiranoli421_db_user:keFt9XKE7oIdaAY2@cluster0. dxc9xkf.mongodb. net/';
$database = 'khairawang_dairy';

echo "Testing MongoDB Connection...\n\n";

try {
$client = new Client($mongoUri);
$db = $client->selectDatabase($database);

echo "Connected!\n\n";

$users = $db->selectCollection('users');
$admin = $users->findOne(['email' => 'admin@khairawangdairy.com']);

if ($admin) {
echo "Admin found!\n";
echo "Email: " . $admin['email'] . "\n";
echo "Status: " . $admin['status'] . "\n";

if (password_verify('admin123', $admin['password'])) {
echo "Password is CORRECT!\n";
} else {
echo "Password does NOT match!\n";
}
} else {
echo "Admin NOT found! Creating now...\n";

$roles = $db->selectCollection('roles');
$adminRole = $roles->findOne(['name' => 'admin']);

if (! $adminRole) {
$roles->insertOne(['name' => 'admin', 'permissions' => ['*']]);
$adminRole = $roles->findOne(['name' => 'admin']);
}

$password = password_hash('admin123', PASSWORD_BCRYPT);

$users->insertOne([
'role_id' => (string)$adminRole['_id'],
'email' => 'admin@khairawangdairy.com',
'password' => $password,
'name' => 'Admin User',
'status' => 'active'
]);

echo "Admin created!\n";
echo "Email: admin@khairawangdairy.com\n";
echo "Password: admin123\n";
}

} catch (Exception $e) {
echo "Error: " . $e->getMessage() . "\n";
}
